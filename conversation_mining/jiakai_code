from pymongo import MongoClient
from datetime import datetime, timedelta
from tqdm import tqdm

# Connect to MongoDB
client = MongoClient('mongodb://localhost:27017/')
db = client['DBL']

# Define collection names
user_convo_starters_collection = 'user_starts_conversation'
replies_collection = 'replies'

# Retrieve user starting conversation objects
user_convo_starters = list(db[user_convo_starters_collection].find())

# Print the length of user_convo_starters
print(f"Number of conversations to process: {len(user_convo_starters)}")

# Define the time threshold for 24 hours ago
time_threshold = datetime.utcnow() - timedelta(hours=24)

# Initialize tqdm progress bar
pbar = tqdm(total=len(user_convo_starters), desc="Processing conversations")

# Iterate over user starting conversation objects
for convo_starter in user_convo_starters:
    # Retrieve associated replies
    replies = db[replies_collection].find({'in_reply_to_status_id_str': convo_starter['id_str']})
    
    # Filter replies made within 24 hours
    replies_to_delete = []
    for reply in replies:
        reply_timestamp = datetime.strptime(reply['created_at'], '%a %b %d %H:%M:%S +0000 %Y')
        if reply_timestamp < time_threshold:
            replies_to_delete.append(reply['_id'])
    
    # Delete filtered replies
    if replies_to_delete:
        db[replies_collection].delete_many({'_id': {'$in': replies_to_delete}})
        print(f"Deleted {len(replies_to_delete)} replies for user starting conversation with ID: {convo_starter['id_str']}")
    else:
        print(f"No replies to delete for user starting conversation with ID: {convo_starter['id_str']}")
    
    # Update progress bar
    pbar.update(1)

# Close progress bar
pbar.close()
